<div class="container">
    <div class="row">
        <div class="col-xs-12">
            <h1 class="page-header"><%= @site.name %> <small><%= @site.url %></small></h1>
        </div>
    </div>

    <div class="row">
        <form>
            <div class="col-sm-6 hidden-xs">
                <h4><%= @start_date.strftime("%B %d, %Y") %> <small> to </small> <%= @end_date.strftime("%B %d, %Y") %></h4>
            </div>
            <div class="form-group col-sm-4 ">
                <div class="input-daterange input-group">
                    <input type="text" class="form-control" name="start_date" value="<%= @start_date.to_s(:db) %>" />
                    <span class="input-group-addon">to</span>
                    <input type="text" class="form-control" name="end_date" value="<%= @end_date.to_date.to_s(:db) %>" />
                </div>
            </div>
            <div class="col-sm-2">
                <button class="btn btn-primary btn-block">Refresh</button>
            </div>
        </form>
    </div>
    <div class="row">
        <div class="col-xs-12">
            <div id="page-view-chart" class="chart"></div>
        </div>
        <!-- <div class="col-sm-4">
            <div id="browser-chart" class="chart"></div>
        </div> -->
    </div>

    <div class="row">
        <div class="col-sm-4">
            <div class="panel panel-default">
                <div class="panel-body metric-panel text-center">
                    <%= number_with_delimiter(@site.site_events.where(created_at: @start_date..@end_date).count()) %>
                </div>
                <div class="panel-footer text-center">
                    Total Visits
                </div>
            </div>
        </div>
        <div class="col-sm-2">
            <div class="panel panel-default">
                <div class="panel-body metric-panel text-center">
                    <%= @site.get_unique_by(@start_date, @end_date, "ip").count() %>
                </div>
                <div class="panel-footer text-center">
                    Unique Visits
                </div>
            </div>
        </div>
        <div class="col-sm-2">
            <div class="panel panel-default">
                <div class="panel-body metric-panel text-center">
                    <%= @site.get_unique_by(@start_date, @end_date, "path").count() %>
                </div>
                <div class="panel-footer text-center">
                    Unique Pages
                </div>
            </div>
        </div>
        <div class="col-sm-2">
            <div class="panel panel-default">
                <div class="panel-body metric-panel text-center">
                    <%= @site.get_unique_by(@start_date, @end_date, "browser").count() %>
                </div>
                <div class="panel-footer text-center">
                    Browsers
                </div>
            </div>
        </div>
        <div class="col-sm-2">
            <div class="panel panel-default">
                <div class="panel-body metric-panel text-center">
                    <%= @site.get_unique_by(@start_date, @end_date, "platform").count() %>
                </div>
                <div class="panel-footer text-center">
                    Operating Systems
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <ul class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active">
                    <a href="#pages" aria-controls="pages" role="tab" data-toggle="tab">Pages</a>
                </li>
                <li role="presentation">
                    <a href="#browsers" aria-controls="browsers" role="tab" data-toggle="tab">Browsers</a>
                </li>
                <li role="presentation">
                    <a href="#users" aria-controls="users" role="tab" data-toggle="tab">Users</a>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Pages Content -->
                <div role="tabpanel" class="tab-pane active" id="pages">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Page</th>
                                    <th>Views</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% @popular_pages.each do |page| %>
                                <tr>
                                    <td><%= page.path %></td>
                                    <td><%= number_with_delimiter(page.count) %></td>
                                </tr>
                                <% end %>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Browsers Content -->
                <div role="tabpanel" class="tab-pane" id="browsers">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Browser</th>
                                    <th>Views</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% @browser_breakdown.each do |page| %>
                                <tr>
                                    <td><%= page.browser %></td>
                                    <td><%= number_with_delimiter(page.count) %></td>
                                </tr>
                                <% end %>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Users Content -->
                <div role="tabpanel" class="tab-pane" id="users">...</div>
            </div>
        </div>
    </div>
</div>

<% content_for :footer_javascript do %>
    $('.input-daterange').datepicker({
        todayBtn: "linked",
        autoclose: true,
        todayHighlight: true,
        endDate: "today",
        startDate: "-1y",
        format: "yyyy-mm-dd"
    });

    // Make monochrome colors and set them as default for all pies
    Highcharts.getOptions().plotOptions.pie.colors = (function () {
        var colors = [],
            base = Highcharts.getOptions().colors[0],
            i;

        for (i = 0; i < 10; i += 1) {
            // Start out with a darkened base color (negative brighten), and end
            // up with a much brighter color
            colors.push(Highcharts.Color(base).brighten((i - 3) / 7).get());
        }
        return colors;
    }());

    $('#page-view-chart').highcharts({
        chart: {
            type: 'area'
        },
        title: {
            text: null
        },
        xAxis: {
            type: 'datetime',
            dateTimeLabelFormats: {
                month: '%e. %b',
                year: '%b'
            },
        },
        tooltip: {
            headerFormat: '<b>{series.name}</b><br>',
            pointFormat: '{point.x:%B %e, %Y}: {point.y} Views'
        },
        series: [
            {
                name: 'Page Views Per Day',
                data: <%= @page_visit_data.map { |d| [(Time.parse(d["day"]).to_f * 1000), d["count"].to_i] }.to_json.html_safe %>
            }
        ],
        credits: false
    });

    $('#browser-chart').highcharts({
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false,
            type: 'pie'
        },
        title: {
            text: 'Visits By Browser'
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: false,
                    format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                    style: {
                        color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                    }
                }
            }
        },
        series: [{
            name: 'Browsers',
            colorByPoint: true,
            data: <%= @browser_breakdown.map { |b| {name: b.browser, y: b.count} }.to_json.html_safe %>
        }],
        credits: false,
        yAxis: {
            title: {
                text: null
            }
        }
    });
<% end %>